<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>客户余额 - 管理系统</title>
  <!-- 生产环境资源 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/element-plus@2.3.9/dist/index.css">
  <script src="https://unpkg.com/element-plus@2.3.9/dist/index.full.min.js"></script>
  <link rel="icon" href="/img/header.png" type="image/x-icon">
  <!-- Tailwind CSS引入 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            success: '#00B42A',
            warning: '#FF7D00',
            danger: '#F53F3F',
            'neutral-100': '#F2F3F5',
            'neutral-200': '#E5E6EB',
            'neutral-300': '#C9CDD4',
            'neutral-400': '#86909C',
            'neutral-500': '#4E5969',
            'neutral-600': '#1D2129',
          },
          fontFamily: { inter: ['Inter', 'system-ui', 'sans-serif'] },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    body {
            cursor: url('/img/mouse.png'), auto;
            position: relative; /* 确保水印能正确定位 */
        }
    @layer utilities {
      .content-auto { content-visibility: auto; }
      .card-shadow { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
      .hover-lift { transition: transform 0.2s, box-shadow 0.2s; }
      .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 6px 24px rgba(0, 0, 0, 0.12); }
      .text-ellipsis { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      
      /* 用户下拉菜单样式 */
      .user-dropdown {
        position: absolute;
        right: 0;
        top: 100%;
        margin-top: 5px;
        width: 180px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        z-index: 100;
        overflow: hidden;
        transform-origin: top right;
        transform: scale(0.95);
        opacity: 0;
        pointer-events: none;
        transition: all 0.2s ease;
      }
      .user-dropdown.active {
        transform: scale(1);
        opacity: 1;
        pointer-events: all;
      }
    }
  </style>

  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- xlsx库用于导出Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- 请求拦截器 -->
  <script>
    (function() {
      const originalFetch = window.fetch;
      window.fetch = function(url, options = {}) {
          if (typeof url === 'string' && (url.includes('wdbso.vip') || url.startsWith('/'))) {
              if (!url.includes('wdbso.vip/a') && !url.includes('wdbso.vip/b')) {
                  if (!options.headers) {
                      options.headers = {};
                  }
                  const hash = localStorage.getItem('hash');
                  if (hash) {
                      options.headers['token'] = hash;
                  }
              }
          }
          return originalFetch(url, options);
      };
      
      const originalXHROpen = XMLHttpRequest.prototype.open;
      XMLHttpRequest.prototype.open = function(method, url) {
          if (typeof url === 'string' && url.includes('wdbso.vip')) {
              this._url = url;
          }
          return originalXHROpen.apply(this, arguments);
      };
      
      const originalXHRSend = XMLHttpRequest.prototype.send;
      XMLHttpRequest.prototype.send = function(body) {
          if (this._url && this._url.includes('wdbso.vip')) {
              if (!this._url.includes('wdbso.vip/a') && !this._url.includes('wdbso.vip/b')) {
                  const hash = localStorage.getItem('hash');
                  if (hash) {
                      this.setRequestHeader('token', hash);  
                  }
              }
          }
          return originalXHRSend.call(this, body);
      };
    })();
  </script>

  <!-- 客户余额页面专用样式 -->
  <style>
    .dashboard {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }
    
    .dashboard .header {
      padding: 16px 20px;
      border-bottom: 1px solid #e0e0e0;
      background-color: #f5f7fa;
    }
    
    .dashboard .header h1 {
      margin: 0;
      font-size: 18px;
      color: #1D2129;
      font-weight: 600;
    }
    
    .dashboard .content {
      padding: 20px;
    }
    
    #customerBalanceTable {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }
    
    #customerBalanceTable th,
    #customerBalanceTable td {
      border: 1px solid #e0e0e0;
      padding: 10px 12px;
      text-align: left;
      font-size: 14px;
    }
    
    #customerBalanceTable th {
      background-color: #f5f7fa;
      font-weight: 600;
      color: #4E5969;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    #customerBalanceTable tr:hover {
      background-color: #f9f9f9;
    }
    
    .highlight-row {
      background-color: #fff8f8;
    }
    
    .status-warning {
      color: #F53F3F;
      font-weight: 500;
    }
    
    .table-container {
      overflow-x: auto;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
    }
    
    .filter-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 1px dashed #e0e0e0;
    }
    
    .search-box {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .search-input {
      width: 300px;
      padding: 6px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
    }
    
    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .btn-primary {
      background-color: #165DFF;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #0E4CD1;
    }
    
    .btn-export {
      background-color: #2196F3;
      color: white;
    }
    
    .btn-export:hover {
      background-color: #0b7dda;
    }
    
    .summary-stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .stat-card {
      flex: 1;
      min-width: 150px;
      background-color: #f9f9f9;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #165DFF;
    }
    
    .stat-card.warning {
      border-left-color: #F53F3F;
    }
    
    .stat-title {
      font-size: 14px;
      color: #86909C;
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: #1D2129;
    }
    
    .stat-card.warning .stat-value {
      color: #F53F3F;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #86909C;
      font-size: 16px;
    }
    
    .loading i {
      margin-right: 8px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #86909C;
    }
    
    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      color: #C9CDD4;
    }
    
    .empty-state p {
      margin: 0;
      font-size: 16px;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
      gap: 10px;
    }
    
    .pagination button {
      padding: 6px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
      cursor: pointer;
      white-space: nowrap;
      font-size: 14px;
    }
    
    .pagination button.active {
      background-color: #165DFF;
      color: white;
      border-color: #165DFF;
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .pagination-info {
      text-align: center;
      margin: 10px 0;
      color: #86909C;
      font-size: 14px;
    }
          /* 水印样式 - 确保覆盖整个页面 */
      .watermark-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;  /* 视窗宽度 */
        height: 100vh; /* 视窗高度 */
        pointer-events: none; /* 不影响交互 */
        z-index: 999; /* 确保在内容上方但不遮挡UI元素 */
        overflow: hidden;
        opacity: 0.04; /* 更淡的透明度，不影响内容阅读 */
        background-repeat: repeat; /* 重复平铺 */
      }
      .watermark-text {
        position: absolute;
        font-size: 28px; /* 稍大的字体 */
        font-weight: 600;
        color: #000000;
        transform: rotate(-45deg);
        white-space: nowrap; /* 防止文本换行 */
        user-select: none; /* 禁止选择 */
        display: block;
      }
  </style>
</head>

<body class="font-inter bg-neutral-100 text-neutral-600 min-h-screen flex flex-col">
  <div id="app" class="flex flex-col h-screen overflow-hidden">
      <div class="watermark-container" id="watermarkContainer"></div>
    <!-- 顶部导航栏 -->
    <header class="bg-white border-b border-neutral-200 shadow-sm z-10">
  <div class="w-full px-4">
    <div class="flex items-center justify-between h-16 max-w-full">
      <!-- 左侧Logo和标题 -->
      <div class="flex items-center space-x-2">
        <!-- 汉堡菜单按钮 -->
        <button id="menuToggle" class="md:hidden text-neutral-600 hover:text-primary mr-2">
          <i class="fa fa-bars text-xl"></i>
        </button>
        <div class="text-primary text-2xl">
          <i class="fa fa-truck"></i>
        </div>
        <h1 class="text-xl font-bold text-neutral-600 whitespace-nowrap">管理系统</h1>
      </div>
      
      <!-- 右侧用户区域 - 新增下拉菜单功能 -->
      <div class="flex items-center space-x-6 ml-auto">
        <!-- 通知图标 -->
        <div class="relative cursor-pointer hover:text-primary transition-colors">
          <i class="fa fa-bell-o text-lg"></i>
          <span class="absolute -top-1 -right-1 bg-danger text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">3</span>
        </div>
        
        <!-- 用户信息及下拉菜单 -->
        <div class="relative" id="userContainer">
          <div class="flex items-center space-x-3 cursor-pointer group" id="userMenu">
            <img src="/img/1.png" alt="用户头像" class="w-8 h-8 rounded-full object-cover border-2 border-white shadow-sm">
            <span class="font-medium hidden md:inline-block" id="usernameDisplay">加载中...</span>
            <i class="fa fa-angle-down text-neutral-400 group-hover:text-primary transition-colors"></i>
          </div>
          
          <!-- 用户下拉菜单 -->
          <div class="user-dropdown" id="userDropdown">
            <div class="py-2">
              <a href="kh/settings.html" class="block px-4 py-2 text-sm text-neutral-600 hover:bg-neutral-100 transition-colors">
                <i class="fa fa-user-o mr-2 text-neutral-400"></i>个人中心
              </a>
              <a href="kh/settings.html" class="block px-4 py-2 text-sm text-neutral-600 hover:bg-neutral-100 transition-colors">
                <i class="fa fa-cog mr-2 text-neutral-400"></i>系统设置
              </a>
              <div class="border-t border-neutral-100 my-1"></div>
              <button id="logoutBtn" class="w-full text-left px-4 py-2 text-sm text-danger hover:bg-neutral-100 transition-colors">
                <i class="fa fa-sign-out mr-2"></i>退出登录
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

    
    <!-- 主内容区 -->
    <div class="flex flex-1 overflow-hidden">
      <!-- 侧边导航 -->
      <aside class="w-64 bg-white border-r border-neutral-200 flex-shrink-0 hidden md:block transition-all duration-300" id="sidebar">
        <nav class="py-4 h-full flex flex-col">
          <div class="px-4 mb-4">
            <div class="relative">
              <input type="text" placeholder="搜索功能..." class="w-full py-2 px-3 pl-10 rounded-lg bg-neutral-100 border border-transparent focus:border-primary focus:ring-1 focus:ring-primary focus:outline-none transition-all text-sm">
              <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-neutral-400"></i>
            </div>
          </div>
          
          <ul class="flex-1 overflow-y-auto py-2">
            <li class="mb-1">
              <a href="https://wdbso.vip/dashboard.html" class="nav-link flex items-center px-4 py-3 text-neutral-500 hover:bg-neutral-100 transition-colors">
                <i class="fa fa-dashboard w-5 text-center mr-3"></i>
                <span>数据仪表盘</span>
              </a>
            </li>
            <li class="mb-1">
              <a href="https://wdbso.vip/kh/khwuliu.html" class="nav-link flex items-center px-4 py-3 text-neutral-500 hover:bg-neutral-100 transition-colors">
                <i class="fa fa-history w-5 text-center mr-3"></i>
                <span>客户物流详情</span>
              </a>
            </li>
            <li class="mb-1">
              <a href="khruku.html" class="nav-link flex items-center px-4 py-3 text-neutral-500 hover:bg-neutral-100 transition-colors">
                <i class="fa fa-sign-in w-5 text-center mr-3"></i>
                <span>入库管理</span>
              </a>
            </li>
            <li class="mb-1">
              <a href="https://wdbso.vip/kh/errorOrders.html" class="nav-link flex items-center px-4 py-3 text-neutral-500 hover:bg-neutral-100 transition-colors">
                <i class="fa fa-exclamation-circle w-5 text-center mr-3"></i>
                <span>异常订单管理</span>
              </a>
            </li>
            <!-- 客户余额导航项 - 设置为当前激活状态 -->
            <li class="mb-1">
              <a href="https://wdbso.vip/kh/khyue.html" class="nav-link flex items-center px-4 py-3 text-primary bg-primary/5 border-r-4 border-primary font-medium">
                <i class="fa fa-money w-5 text-center mr-3"></i>
                <span>客户余额</span>
              </a>
            </li>
            <li class="mb-1">
              <a href="https://wdbso.vip/kh/wuliu.html" class="nnav-link flex items-center px-4 py-3 text-neutral-500 hover:bg-neutral-100 transition-colors">
                <i class="fa fa-bar-chart w-5 text-center mr-3"></i>
                <span>物流查询</span>
              </a>
            </li>
            <!-- SKU排行榜导航项 -->
            <li class="mb-1">
              <a href="https://wdbso.vip/kh/khsku.html" class="nnav-link flex items-center px-4 py-3 text-neutral-500 hover:bg-neutral-100 transition-colors">
                <i class="fa fa-bar-chart w-5 text-center mr-3"></i>
                <span>SKU排行榜</span>
              </a>
            </li>
            <li class="mb-1">
              <a href="https://wdbso.vip/kh/everyday.html" class="nav-link flex items-center px-4 py-3 text-neutral-500 hover:bg-neutral-100 transition-colors">
                <i class="fa fa-calendar-check-o w-5 text-center mr-3"></i>
                <span>每日看板</span>
              </a>
            </li>
            <li class="mb-1">
              <a href="https://wdbso.vip/kh/jianhuo.html" class="nav-link flex items-center px-4 py-3 text-neutral-500 hover:bg-neutral-100 transition-colors">
                <i class="fa fa-clock-o w-5 text-center mr-3"></i>
                <span>拣货时效管理</span>
              </a>
            </li>
            <li class="mb-1">
              <a href="kh/settings.html" class="nav-link flex items-center px-4 py-3 text-neutral-500 hover:bg-neutral-100 transition-colors">
                <i class="fa fa-cog w-5 text-center mr-3"></i>
                <span>系统设置</span>
              </a>
            </li>
          </ul>
          
          <!-- 底部帮助区域 -->
          <div class="p-4 border-t border-neutral-200">
            <div class="bg-primary/5 rounded-lg p-3">
              <h4 class="font-medium text-primary text-sm mb-2">需要帮助？</h4>
              <p class="text-neutral-500 text-xs mb-3">查看帮助文档或联系技术支持</p>
              <a href="#" class="text-xs text-primary hover:underline">
                <i class="fa fa-question-circle mr-1"></i> 帮助中心
              </a>
            </div>
          </div>
        </nav>
      </aside>
      
      <!-- 客户余额模块内容 -->
      <main class="flex-1 overflow-y-auto p-4 md:p-6">
        <!-- 页面标题和操作区 -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
          <div>
            <h2 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-neutral-600">客户余额管理</h2>
            <p class="text-neutral-400 mt-1">实时监控客户账户余额及信用额度使用情况</p>
          </div>
          
          <div class="flex items-center space-x-3 mt-4 md:mt-0">
            <button id="refreshData" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-colors flex items-center hover-lift">
              <i class="fa fa-refresh mr-2"></i>
              <span>刷新数据</span>
            </button>
            <button id="exportExcel" class="bg-success hover:bg-success/90 text-white px-4 py-2 rounded-lg transition-colors flex items-center hover-lift">
              <i class="fa fa-download mr-2"></i>
              <span>导出Excel</span>
            </button>
          </div>
        </div>
        
        <!-- 客户余额功能区 -->
        <section id="getcustomer_balance">
          <div class="dashboard card-shadow">
            <div class="header">
              <h1>客户余额状态</h1>
            </div>
            <div class="content">
              <!-- 统计概览 -->
              <div class="summary-stats">
                <div class="stat-card">
                  <div class="stat-title">总客户数</div>
                  <div class="stat-value" id="totalCustomers">0</div>
                </div>
                <div class="stat-card warning">
                  <div class="stat-title">余额不足客户</div>
                  <div class="stat-value" id="lowBalanceCustomers">0</div>
                </div>
                <div class="stat-card warning">
                  <div class="stat-title">即将到期客户</div>
                  <div class="stat-value" id="expiringSoonCustomers">0</div>
                </div>
                <div class="stat-card">
                  <div class="stat-title">正常客户</div>
                  <div class="stat-value" id="normalCustomers">0</div>
                </div>
              </div>
              
              <!-- 搜索和筛选 -->
              <div class="filter-bar">
                <div class="search-box">
                  <input type="text" id="customerSearch" class="search-input border-neutral-200 focus:border-primary focus:ring-1 focus:ring-primary transition-all" placeholder="搜索客户名称或代码...">
                  <select id="statusFilter" class="search-input border-neutral-200 focus:border-primary focus:ring-1 focus:ring-primary transition-all">
                    <option value="all">全部状态</option>
                    <option value="warning">需关注客户</option>
                    <option value="normal">正常客户</option>
                  </select>
                </div>
                <div class="action-buttons">
                  <button id="resetFilters" class="btn bg-neutral-200 hover:bg-neutral-300 text-neutral-600 hover-lift">
                    <i class="fa fa-refresh"></i>
                    <span>重置</span>
                  </button>
                </div>
              </div>
              
              <!-- 加载状态 -->
              <div class="loading" id="loadingIndicator">
                <i class="fa fa-circle-o-notch"></i>
                <span>正在加载客户余额数据...</span>
              </div>
              
              <!-- 空状态 -->
              <div class="empty-state" id="emptyState" style="display: none;">
                <i class="fa fa-inbox"></i>
                <p>没有找到客户余额数据</p>
              </div>
              
              <!-- 表格容器 -->
              <div class="table-container" id="tableContainer" style="display: none;">
                <table id="customerBalanceTable">
                    <thead>
                        <tr>
                            <th>客户名称</th>
                            <th>余额</th>
                            <th>信用额度</th>
                            <th>总余额</th>
                            <th>剩余可用天数</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 数据将通过 JavaScript 动态填充 -->
                    </tbody>
                </table>
              </div>
              
              <!-- 分页信息 -->
              <div class="pagination-info" id="paginationInfo" style="display: none;">
                  共 <span id="totalRecords">0</span> 条记录，当前第 <span id="currentPage">1</span> 页，每页 <span id="pageSize">20</span> 条
              </div>
              
              <!-- 分页控件 -->
              <div class="pagination" id="paginationControls" style="display: none;">
                  <button id="firstPage" disabled class="hover-lift">首页</button>
                  <button id="prevPage" disabled class="hover-lift">上一页</button>
                  <div id="pageNumbers"></div>
                  <button id="nextPage" class="hover-lift">下一页</button>
                  <button id="lastPage" class="hover-lift">末页</button>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- 客户余额功能脚本 -->
  <script>
  // 初始化水印（确保覆盖整个页面）
    function initWatermark(username) {
      const container = document.getElementById('watermarkContainer');
      if (!container || !username) return;
      
      // 清空现有水印
      container.innerHTML = '';
      
      // 获取视窗尺寸，确保水印覆盖整个可见区域
      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;
      
      // 计算水印数量和间距（增加密度确保完全覆盖）
      const step = 200; // 水印间距（像素）- 更小的间距意味着更密集的水印
      const horizontalCount = Math.ceil(windowWidth / step) + 1; // 水平方向水印数量
      const verticalCount = Math.ceil(windowHeight / step) + 1;   // 垂直方向水印数量
      
      // 创建水印网格
      for (let i = 0; i < verticalCount; i++) {
        for (let j = 0; j < horizontalCount; j++) {
          const watermark = document.createElement('div');
          watermark.className = 'watermark-text';
          watermark.textContent = username;
          
          // 计算位置（覆盖整个视窗）
          const left = j * step - step/2; // 向左偏移一半间距，确保边缘也有覆盖
          const top = i * step - step/2;  // 向上偏移一半间距
          
          // 设置位置和样式
          watermark.style.left = `${left}px`;
          watermark.style.top = `${top}px`;
          
          container.appendChild(watermark);
        }
      }
    }
    // 全局变量
    let allCustomerData = [];
    let filteredData = [];
    let currentPage = 1;
    const pageSize = 20;
    let totalPages = 0;
    let totalRecords = 0;

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 验证登录状态
        const username = localStorage.getItem('username');
        if (!username) {
            window.location.href = 'https://wdbso.vip/index-login.html';
            return;
        }
        // 获取并显示用户名
        const usernameDisplay = document.getElementById('usernameDisplay');
        if (usernameDisplay) {
          usernameDisplay.textContent = username || '未知用户';
        }
         // 初始化水印（确保覆盖整个页面）
          initWatermark(username);
          
          // 监听窗口大小变化，重新调整水印
          window.addEventListener('resize', () => {
            initWatermark(username);
          });
        // 初始化用户菜单
        initUserMenu();
        
        // 绑定事件
        bindEvents();
        
        // 加载客户余额数据
        fetchCustomerBalanceData();
    });

    // 初始化用户菜单
    function initUserMenu() {
        const userMenu = document.getElementById('userMenu');
        const userDropdown = document.getElementById('userDropdown');
        
         // 用户区域切换下拉菜单
        userMenu.addEventListener('mouseenter', (e) => {
            e.stopPropagation();
            userDropdown.classList.toggle('active');
        });
        
        // 鼠标移出隐藏下拉菜单
        userContainer.addEventListener('mouseleave', () => {
          userDropdown.classList.remove('active');
        });
        
        // 退出登录功能
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('确定要退出登录吗？')) {
                localStorage.removeItem('username');
                localStorage.removeItem('hash');
                window.location.href = 'https://wdbso.vip/index-login.html';
            }
        });
    }

    // 绑定所有事件处理程序
    function bindEvents() {
        // 刷新数据按钮
        document.getElementById('refreshData').addEventListener('click', function() {
            this.innerHTML = '<i class="fa fa-circle-o-notch fa-spin mr-2"></i><span>刷新中...</span>';
            this.disabled = true;
            
            setTimeout(() => {
                fetchCustomerBalanceData().then(() => {
                    this.innerHTML = '<i class="fa fa-refresh mr-2"></i><span>刷新数据</span>';
                    this.disabled = false;
                });
            }, 500);
        });
        
        // 导出Excel按钮
        document.getElementById('exportExcel').addEventListener('click', exportToExcel);
        
        // 搜索框事件
        document.getElementById('customerSearch').addEventListener('input', function() {
            filterAndRenderData();
        });
        
        // 状态筛选事件
        document.getElementById('statusFilter').addEventListener('change', function() {
            filterAndRenderData();
        });
        
        // 重置筛选按钮
        document.getElementById('resetFilters').addEventListener('click', function() {
            document.getElementById('customerSearch').value = '';
            document.getElementById('statusFilter').value = 'all';
            filterAndRenderData();
        });
        
        // 分页事件
        document.getElementById('firstPage').addEventListener('click', function() {
            if (currentPage !== 1) {
                currentPage = 1;
                renderPagedData();
            }
        });
        
        document.getElementById('prevPage').addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                renderPagedData();
            }
        });
        
        document.getElementById('nextPage').addEventListener('click', function() {
            if (currentPage < totalPages) {
                currentPage++;
                renderPagedData();
            }
        });
        
        document.getElementById('lastPage').addEventListener('click', function() {
            if (currentPage !== totalPages) {
                currentPage = totalPages;
                renderPagedData();
            }
        });
        
        // 汉堡菜单切换
        document.getElementById('menuToggle').addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('absolute');
            sidebar.classList.toggle('z-20');
        });
    }

    // 获取客户余额数据
    async function fetchCustomerBalanceData() {
        try {
            // 显示加载状态
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('tableContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('paginationInfo').style.display = 'none';
            document.getElementById('paginationControls').style.display = 'none';
            
            // 调用API获取数据
            console.log('发起接口请求: /getcustomer_balance');
            const response = await fetch('/getcustomer_balance');
            
            if (!response.ok) {
                throw new Error(`网络响应不正常: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('接口返回数据:', result);
            
            if (!result.success || !result.data) {
                throw new Error(result.details || '获取客户余额数据失败');
            }
            
            // 保存原始数据
            allCustomerData = result.data;
            
            // 筛选并渲染数据
            filterAndRenderData();
            
        } catch (error) {
            console.error('获取客户余额数据时出错:', error);
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('emptyState').innerHTML = `
                <i class="fa fa-exclamation-triangle"></i>
                <p>加载失败: ${error.message}</p>
                <p style="margin-top: 10px;"><button id="retryLoad" class="btn btn-primary">重试</button></p>
            `;
            
            // 绑定重试按钮事件
            document.getElementById('retryLoad').addEventListener('click', fetchCustomerBalanceData);
        }
    }

    // 筛选并渲染数据
    function filterAndRenderData() {
        // 获取搜索和筛选条件
        const searchTerm = document.getElementById('customerSearch').value.toLowerCase().trim();
        const statusFilter = document.getElementById('statusFilter').value;
        
        // 应用筛选
        filteredData = allCustomerData.filter(customer => {
            // 搜索筛选
            const matchesSearch = searchTerm === '' || 
                customer.客户.toLowerCase().includes(searchTerm) ||
                (customer.客户代码 && customer.客户代码.toLowerCase().includes(searchTerm));
            
            if (!matchesSearch) return false;
            
            // 状态筛选
            if (statusFilter === 'all') return true;
            
            const totalBalance = parseFloat(customer.总余额);
            const remainingDays = parseFloat(customer.剩余可用天数);
            const isWarning = (parseFloat(customer.余额) < 100 || totalBalance < 100 || remainingDays < 3) && 
                             !(totalBalance === 0 && remainingDays === 0);
            
            return (statusFilter === 'warning' && isWarning) || 
                   (statusFilter === 'normal' && !isWarning);
        });
        
        // 排序数据
        filteredData.sort((a, b) => {
            const totalBalanceA = parseFloat(a.总余额);
            const totalBalanceB = parseFloat(b.总余额);
            const balanceA = parseFloat(a.余额);
            const balanceB = parseFloat(b.余额);
            const remainingDaysA = parseFloat(a.剩余可用天数);
            const remainingDaysB = parseFloat(b.剩余可用天数);

            // 总余额和可用余额都为 0 的记录排在最后
            const zeroA = totalBalanceA === 0 && balanceA === 0;
            const zeroB = totalBalanceB === 0 && balanceB === 0;
            if (zeroA !== zeroB) {
                return zeroA ? 1 : -1;
            }

            // 可用天数升序排序
            if (remainingDaysA !== remainingDaysB) {
                return remainingDaysA - remainingDaysB;
            }

            // 总余额降序排序
            return totalBalanceB - totalBalanceA;
        });
        
        // 更新统计数据
        updateStatistics();
        
        // 重置页码
        currentPage = 1;
        
        // 渲染分页数据
        renderPagedData();
    }

    // 更新统计数据
    function updateStatistics() {
        const total = filteredData.length;
        
        // 计算需关注客户数量（余额不足或即将到期）
        const warningCount = filteredData.filter(customer => {
            const totalBalance = parseFloat(customer.总余额);
            const remainingDays = parseFloat(customer.剩余可用天数);
            return (parseFloat(customer.余额) < 100 || totalBalance < 100 || remainingDays < 3) && 
                   !(totalBalance === 0 && remainingDays === 0);
        }).length;
        
        // 计算即将到期客户数量
        const expiringCount = filteredData.filter(customer => {
            const remainingDays = parseFloat(customer.剩余可用天数);
            const totalBalance = parseFloat(customer.总余额);
            return remainingDays < 3 && !(totalBalance === 0 && remainingDays === 0);
        }).length;
        
        // 更新统计数字
        document.getElementById('totalCustomers').textContent = total;
        document.getElementById('lowBalanceCustomers').textContent = warningCount;
        document.getElementById('expiringSoonCustomers').textContent = expiringCount;
        document.getElementById('normalCustomers').textContent = total - warningCount;
    }

    // 渲染分页数据
    function renderPagedData() {
        // 计算总页数
        totalRecords = filteredData.length;
        totalPages = Math.max(1, Math.ceil(totalRecords / pageSize));
        
        // 确保当前页在有效范围内
        if (currentPage > totalPages) {
            currentPage = totalPages;
        }
        
        // 获取当前页数据
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, totalRecords);
        const currentPageData = filteredData.slice(startIndex, endIndex);
        
        // 渲染表格数据
        renderTable(currentPageData);
        
        // 更新分页信息
        updatePagination();
        
        // 显示适当的区域
        if (totalRecords === 0) {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'none';
            document.getElementById('paginationInfo').style.display = 'none';
            document.getElementById('paginationControls').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        } else {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'block';
            document.getElementById('paginationInfo').style.display = 'block';
            document.getElementById('paginationControls').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
        }
    }

    // 渲染表格数据
    function renderTable(data) {
        const tableBody = document.getElementById('customerBalanceTable').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '';
        
        data.forEach(customer => {
            // 创建新的表格行
            const row = tableBody.insertRow();
            
            const totalBalance = parseFloat(customer.总余额);
            const remainingDays = parseFloat(customer.剩余可用天数);
            const balance = parseFloat(customer.余额);
            
            // 判断是否需要高亮显示
            const shouldHighlight = (balance < 100 || totalBalance < 100 || remainingDays < 3) && 
                                  !(totalBalance === 0 && remainingDays === 0);
            
            if (shouldHighlight) {
                row.classList.add('highlight-row');
            }
            
            // 客户名称：客户 + 客户代码
            const customerNameCell = row.insertCell(0);
            customerNameCell.textContent = `${customer.客户}(${customer.客户代码 || '-'})`;
            if (shouldHighlight) {
                customerNameCell.style.color = '#F53F3F';
            }
            
            // 余额
            const balanceCell = row.insertCell(1);
            balanceCell.textContent = customer.余额;
            if (balance < 100 && !(totalBalance === 0 && remainingDays === 0)) {
                balanceCell.style.color = '#F53F3F';
                balanceCell.style.fontWeight = '500';
            }
            
            // 信用额度
            const creditCell = row.insertCell(2);
            creditCell.textContent = customer.信用额度 || '0';
            
            // 总余额
            const totalBalanceCell = row.insertCell(3);
            totalBalanceCell.textContent = customer.总余额;
            if (totalBalance < 100 && !(totalBalance === 0 && remainingDays === 0)) {
                totalBalanceCell.style.color = '#F53F3F';
                totalBalanceCell.style.fontWeight = '500';
            }
            
            // 剩余可用天数
            const remainingDaysCell = row.insertCell(4);
            remainingDaysCell.textContent = customer.剩余可用天数;
            if (remainingDays < 3 && !(totalBalance === 0 && remainingDays === 0)) {
                remainingDaysCell.style.color = '#F53F3F';
                remainingDaysCell.style.fontWeight = '500';
            }
            
            // 状态
            const statusCell = row.insertCell(5);
            if (shouldHighlight) {
                statusCell.innerHTML = '<span class="status-warning">需关注</span>';
            } else {
                statusCell.textContent = '正常';
            }
        });
    }

    // 更新分页控件
    function updatePagination() {
        // 更新分页信息
        document.getElementById('totalRecords').textContent = totalRecords;
        document.getElementById('currentPage').textContent = currentPage;
        document.getElementById('pageSize').textContent = pageSize;
        
        // 更新分页按钮状态
        const isFirstPage = currentPage === 1;
        const isLastPage = currentPage >= totalPages;
        
        document.getElementById('firstPage').disabled = isFirstPage;
        document.getElementById('prevPage').disabled = isFirstPage;
        document.getElementById('nextPage').disabled = isLastPage;
        document.getElementById('lastPage').disabled = isLastPage;
        
        // 生成页码按钮
        const pageNumbersContainer = document.getElementById('pageNumbers');
        pageNumbersContainer.innerHTML = '';
        
        let startPage = 1;
        let endPage = totalPages;
        
        // 只显示5个页码
        if (totalPages > 5) {
            startPage = Math.max(1, currentPage - 2);
            endPage = Math.min(totalPages, startPage + 4);
            
            // 确保始终显示5个页码
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
        }
        
        // 添加页码按钮
        for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = i === currentPage ? 'active hover-lift' : 'hover-lift';
            button.addEventListener('click', () => {
                if (i !== currentPage) {
                    currentPage = i;
                    renderPagedData();
                }
            });
            pageNumbersContainer.appendChild(button);
        }
    }

    // 导出Excel
    function exportToExcel() {
        if (filteredData.length === 0) {
            alert('没有数据可导出');
            return;
        }
        
        // 显示加载状态
        const exportButton = document.getElementById('exportExcel');
        const originalText = exportButton.innerHTML;
        exportButton.innerHTML = '<i class="fa fa-circle-o-notch fa-spin mr-2"></i><span>导出中...</span>';
        exportButton.disabled = true;
        
        try {
            // 格式化导出数据
            const exportData = filteredData.map(customer => {
                const totalBalance = parseFloat(customer.总余额);
                const remainingDays = parseFloat(customer.剩余可用天数);
                const balance = parseFloat(customer.余额);
                
                let status = '正常';
                if ((balance < 100 || totalBalance < 100 || remainingDays < 3) && 
                    !(totalBalance === 0 && remainingDays === 0)) {
                    status = '需关注';
                }
                
                return {
                    '客户名称': customer.客户,
                    '客户代码': customer.客户代码 || '',
                    '余额': customer.余额,
                    '信用额度': customer.信用额度 || '0',
                    '总余额': customer.总余额,
                    '剩余可用天数': customer.剩余可用天数,
                    '状态': status
                };
            });
            
            // 创建工作簿和工作表
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "客户余额数据");
            
            // 设置列宽
            const wscols = [
                {wch: 20},  // 客户名称
                {wch: 15},  // 客户代码
                {wch: 10},  // 余额
                {wch: 12},  // 信用额度
                {wch: 10},  // 总余额
                {wch: 12},  // 剩余可用天数
                {wch: 10}   // 状态
            ];
            ws['!cols'] = wscols;
            
            // 导出文件
            const fileName = `客户余额数据_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            // 导出成功提示
            setTimeout(() => {
                alert('数据导出成功！');
                exportButton.innerHTML = originalText;
                exportButton.disabled = false;
            }, 500);
            
        } catch (error) {
            console.error('导出Excel失败:', error);
            alert(`导出失败: ${error.message}`);
            exportButton.innerHTML = originalText;
            exportButton.disabled = false;
        }
    }
  </script>
</body>
</html>